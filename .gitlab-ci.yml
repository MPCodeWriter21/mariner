image: python:3.6

stages:
  - lint
  - test
  - build
  - release

before_script:
  - apt -y install libxml2-dev libxslt-dev
  - pip install poetry
  - pip install tox
  - pip install codecov

.code:
  only:
    changes:
      - src/**/*
      - tests/**/*
      - pyproject.toml
      - pylintrc
      - pytest.ini
      - tox.ini

lint:bandit:
  stage: lint
  extends: .code
  script: tox -e bandit

lint:flake8:
  stage: lint
  extends: .code
  script: tox -e flake8

lint:markdown:
  image: ruby:2.6
  stage: lint
  before_script:
    - gem install mdl
  script:
    - mdl -s mdl.rb *.md docs/use.md docs/config.md
  only:
    changes:
      - '*.md'
      - docs/*.md

lint:pylint:
  stage: lint
  extends: .code
  script: tox -e pylint

test:python35:
  image: python:3.5
  stage: test
  extends: .code
  script:
    - tox -e py35
  retry: 1

test:python36:
  stage: test
  extends: .code
  script:
    - tox -e py36
    - codecov --token=69b7f6f2-c281-4b78-862d-396e8e6f8b1b
  retry: 1

build:package:
  stage: build
  script:
    - tox -e build
  artifacts:
    paths:
      - dist
    expire_in: 1 week

release:pypi:
  stage: release
  before_script:
    - pip install twine
  script:
    - twine upload --skip-existing dist/*
  only:
    - tags

pages:
  script:
    - pip install mkdocs
    - pip install mkdocs-cinder
    - mkdocs build -d public/
  artifacts:
    paths:
      - public
  only:
    - master
